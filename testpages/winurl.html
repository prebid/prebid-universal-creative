<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <title>win url test page</title>
</head>
<body>
<script src = "https://cdn.jsdelivr.net/npm/prebid-universal-creative@latest/dist/creative.js"></script>
<script>
/*
TICKET
Description:
Prebid Server is being updated to create hb_winurl targeting variables, that will be used to track events for mobile apps, AMP, and PG.
To make this work we need to update the Prebid Universal Creative.
See https://github.com/prebid/prebid-universal-creative/issues/70

Acceptance Criteria:
the URL in hb_winurl is resolved and hit


ISSUE
Prebid Server is accepting events as outlined in prebid/prebid-server#800. It's also generating event ad targeting as hb_winurl and 'hb_bidid', e.g.
 "ext": {
    "prebid": {
        "type": "banner",
        "targeting": {
            "hb_winurl": "https://prebid-server.rubiconproject.com/event?t=win&b=BIDID&f=i",
            "hb_bidid_rubicon": "4b61fbb6-d864-4a36-b3dc-ef860d104601",
            "hb_size_rubicon": "300x250",
            "hb_cache_id": "731bd2a2-7f84-4080-b499-550a45d4fb9e",
            "hb_cache_path_rubicon": "/cache",
            "hb_cache_host_rubicon": "prebid-cache-us-west.rubiconproject.com",
            "hb_pb": "1.20",
            "hb_pb_rubicon": "1.20",
            "hb_cache_id_rubicon": "731bd2a2-7f84-4080-b499-550a45d4fb9e",
            "hb_cache_path": "/cache",
            "hb_size": "300x250",
            "hb_bidder": "rubicon",
            "hb_bidder_rubicon": "rubicon",
            "hb_cache_host": "prebid-cache-us-west.rubiconproject.com"
        },

To reduce the footprint of the ad targeting variables the proposal here is to send the whole URL only once, then for each bidder supply the BIDID. So the first two targeting variables combine.

So now it's time to have the universal creative look for the existence of hb_winurl and hb_bidid_BIDDECODE, hitting the endpoint when appropriate.

The proposed ad server representation is to add a couple of new entries: ucTagData.winurl and ucTagData.winbidid:

script src = "https://cdn.jsdelivr.net/npm/prebid-universal-creative@latest/dist/creative.js">script

The proposal is that we update the renderAd() function to:

Resolve the 'BIDID' macro in winurl with the value of winbidid
If there's any problem with this process but hb_winurl exists, log a warning and skip
Add the URL to an invisible image similar to the PBJS triggerpixel function in https://github.com/prebid/Prebid.js/blob/master/src/utils.js
*/

    const ucTagData = {};
    ucTagData.adServerDomain = '';
    ucTagData.pubUrl = '%%PATTERN:url%%';
    ucTagData.adId = '%%PATTERN:hb_adid_BIDDERCODE%%';
    ucTagData.cacheHost = '%%PATTERN:hb_cache_host_BIDDERCODE%%';
    ucTagData.cachePath = '%%PATTERN:hb_cache_path_BIDDERCODE%%';
    ucTagData.uuid = '%%PATTERN:hb_cache_id_BIDDERCODE%%';
    ucTagData.mediaType = '%%PATTERN:hb_format_BIDDERCODE%%';
    ucTagData.env = '%%PATTERN:hb_env%%';
    ucTagData.size = '%%PATTERN:hb_size_BIDDERCODE%%';
    ucTagData.hbPb = '%%PATTERN:hb_pb_BIDDERCODE%%';
    ucTagData.winurl = '%%PATTERN:hb_winurl%%';
    ucTagData.winbidid = '%%PATTERN:hb_bidid_BIDDERCODE%%';

    try {
        ucTag.renderAd(document, ucTagData);
    } catch (e) {
        console.log(e);
    }
</script>
</body>
</html>